<!DOCTYPE HTML>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<title>Calidad del aire</title>
		<link rel="stylesheet" href="mi_estilo.css" />
		<script src="libs/Chart.js"></script>
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>


	</head>

	<body>
		<div class="titulo">
			<h2>Visualización de calidad del aire </h2>
		</div>
		<div class='row'>
				<div class="div_form" id="div_form">
					<form id="formulario", onsubmit="return false">
						<div id='noccaa'>
					    <div id='datos'><fieldset>
								<legend>Fecha</legend>
								<input type="date" id="start" name="fecha"
									value="2018-12-31"
									min="1997-01-01" max="2018-12-31">
					    </div></fieldset>
					    <div id='normal'><fieldset>
								<legend>Provincia</legend>
								<select id="provincia" form="formulario">
										<option value="Leon" selected="selected">León</option>
										<option value="Palencia">Palencia</option>
										<option value="Burgos">Burgos</option>
										<option value="Soria">Soria</option>
										<option value="Segovia">Segovia</option>
										<option value="Avila">Ávila</option>
										<option value="Salamanca">Salamanca</option>
										<option value="Zamora">Zamora</option>
										<option value="Valladolid">Valladolid</option>
								 </select>
							</fieldset></div>
					    <div><fieldset>
					       <legend>Hora</legend>
					       <select id="hora" form="formulario">
					           <option value="0" selected="selected">00:00</option>
					           <option value="1">01:00</option>
					           <option value="2">02:00</option>
					           <option value="3">03:00</option>
					           <option value="4">04:00</option>
					           <option value="5">05:00</option>
					           <option value="6">06:00</option>
					           <option value="7">07:00</option>
					           <option value="8">08:00</option>
					           <option value="9">09:00</option>
					           <option value="10">10:00</option>
					           <option value="11">11:00</option>
					           <option value="12">12:00</option>
					           <option value="13">13:00</option>
					           <option value="14">14:00</option>
					           <option value="15">15:00</option>
					           <option value="16">16:00</option>
										 <option value="17">17:00</option>
										 <option value="18">18:00</option>
										 <option value="19">19:00</option>
										 <option value="20">20:00</option>
										 <option value="21">21:00</option>
										 <option value="22">22:00</option>
										 <option value="23">23:00</option>
					       </select>
					   </div>
					  <input type="submit" value="Visualizar" onclick="grafico_2d();"/>
					</form>
				</div>
			</div>
			<div class="representacion" id="representacion">
				<div class="row">
					<div class="mapa" id="mapa3d">

					</div>
					<div class="diagrama">
						<div class="diagrama" id="diagrama">
								<canvas id="line-chart" width="400" height="250"></canvas>
								<script>
								var myChart=null;


								function grafico_2d(){

									var provincia_selected= document.getElementById("provincia").value
									console.log(provincia_selected)
									var fecha_selected=document.getElementById("start").value
									fecha_selected=transformar_fecha(fecha_selected)
									console.log(fecha_selected)
									var etiquetas=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]
									var names=["CO","NO","NO2","O3","PM10","PM25","SO2"]

									var csv = null;
									var datos = (function () {
							        $.ajax({
							            'async': false,
							            'global': false,
													'crossDomain': true,
							            'url': './datos/'+provincia_selected+'.csv',
							            'dataType': 'text',
							            'success': function (data) {
							                csv = data;
							            }
							        });
							        return csv;
							    })();

									var array= csv.split("\n");
									var selected= []

									for (let i of array){
										if (i.includes(fecha_selected)){
											selected.push(i)
										}
									}
									var co=[]
									var no=[]
									var no2=[]
									var o3=[]
									var pm10=[]
									var pm25=[]
									var so2=[]
									for (let i of selected){
										var n=i.split(",");
										co.push(n[1])
										no.push(n[2])
										no2.push(n[3])
										o3.push(n[4])
										pm10.push(n[5])
										pm25.push(n[6])
										so2.push(n[7])
									}


									console.log(no);

									const data = {
										labels: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],
										datasets: [
											{
									      label: 'CO',
									      data: co,
												borderColor: "#0000FF",
									    },
											{
									      label: 'NO',
									      data: no,
												borderColor: "#8A2BE2"
									    },
											{
									      label: 'NO2',
									      data: no2,
												borderColor: "#DC143C",
									    },
											{
									      label: 'O3',
									      data: o3,
												borderColor: "#006400",
									    },
									    {
									      label: 'PM10',
									      data: pm10,
												borderColor: "#FF8C00",
									    },
											{
									      label: 'PM25',
									      data: pm25,
												borderColor: "#00CED1",
									    },
											{
									      label: 'SO2',
									      data: so2,
												borderColor: "#FF00FF",
									    },
										]
									}

									if(myChart==null){
										myChart = new Chart(document.getElementById("line-chart"), {
										  type: 'line',
										  data: data,
										  options: {
										    responsive: true,
										    plugins: {
										      legend: {
										        position: 'top',
										      },
										      title: {
										        display: true,
										        text: 'Chart.js Line Chart'
										      }
										    }
										  },
										});
									} else {
										myChart.config.data = data;
										myChart.update();
									}
								}

								function transformar_fecha(fecha){
									var array_fecha=fecha.split("-")
									var fecha_fixed=array_fecha[2]+"/"+array_fecha[1]+"/"+array_fecha[0]
									return fecha_fixed
								}
								</script>
						</div>
						<div class="leyenda">
							<h5>CO</h5>
							<h5>NO</h5>
							<h5>NO2</h5>
							<h5>O3</h5>
							<h5>PM10</h5>
							<h5>PM25</h5>
							<h5>SO2</h5>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>

</html>
